
---
title: "Data for models"
output: html_document
---

```{r setup, include = FALSE}
library(targets)
library(tidyverse)
```
These targets are used to filter out observations where the bp was measured more than 15 minutes before and after a dose change

```{targets timeBefore}
  tar_target(time_before, 15)
```

```{targets timeAfter}
  tar_target(time_after, 15)
```


First we filter to the data to we need and create splits for cross-fold validation.

```{targets dataModel}
tar_target(dataModel, data_formatted |>
    filter(
      time_pre %in% 0:time_before,
      time_post %in% 5:time_after
    ) |>
    group_by(id) |>
    # only the first bp within the 5-15 min timeframe after dose titration
    distinct(n_nitro, .keep_all = T) |>
    ungroup() |>
    mutate(sbp_diff = sbp_post - sbp_pre, no_diff = 0)|>
    na.omit()) 
  
```

```{targets training}
  tar_target(training, dataModel)
```

```{targets foldsIndex}
  tar_target(foldsIndex, make_kfold(dataModel, 5))
```

```{targets foldsFive}
  tar_target(foldsFive, 
  group_vfold_cv(foldsIndex,
    group = fold,
    v = 5
  ))
```

Next we find the baseline metric for comparison. The predictions need to be better than just passing in the 'pre' sbp as a prediction - we'll call this the baseline.

```{targets baselineTraining}
  tar_target(baselineTraining, training |>
    metrics(
      truth = sbp_post,
      estimate = sbp_pre
    ))
```

