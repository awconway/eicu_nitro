---
title: "Pre-processing data"
output: html_document
---

```{r setup, include = FALSE}
library(targets)
```


## Pre-processing

Processes data from bigquery database into the format needed for analysis. 


```{targets joinedTables, tar_simple=TRUE}
eicu::join_tables(
      patient = patient,
      nitro = nitro,
      sbp_nurse_charting = sbp_nurse_charting,
      vital_aperiodic = vital_aperiodic,
      vital_periodic = vital_periodic,
      apachepatientresult = apachepatientresult,
      apachepredvar = apachepredvar,
      creat = creat,
      fentanyl = fentanyl,
      midaz = midaz,
      propofol = propofol,
      dobutamine = dobutamine,
      dex = dex,
      nicardipine = nicardipine,
      amiodarone = amiodarone,
      fluids = fluids,
      milrinone = milrinone,
      epinephrine = epinephrine,
      vasopressin = vasopressin,
      diltiazem = diltiazem,
      # this pain variable codes NAs as zero pain scores
      pain = pain
    )
```

```{targets dataFormattedRaw, tar_simple=TRUE}
eicu::make_data_format(joinedTables)
```

Here we filter out nitro dose titration that don't fit the typical approach used for titration by nurses. In most hospital policy, there are directions to seek medical orders where the blood pressure exceeds a limit (we have used 200mmHg) and dose titrations would not typically exceed a moderate amount (we have used 20mcg/min).

The final step filters out observations of blood pressure (>200mmHg) and nitroglycerin doses (>50mcg/min) or titrations (>20mcg/min) that are not consistent with nurses' typical dose titration practices. 

```{targets dataFormatted}
tar_target(data_formatted,
dataFormattedRaw|>
    mutate(
      nitro_diff_mcg = nitro_post - nitro_pre)|>
        #performs well
    #  filter(sbp_pre <= 200,
    # nitro_pre <= 50 | nitro_post >= 50,
    # nitro_diff <= 20)
    #performs well
    #  filter(sbp_pre <= 200 | sbp_post <= 200,
    # nitro_pre <= 50 | nitro_post >= 50,
    # nitro_diff <= 20)
    # probably most resembling policy
    filter(
      sbp_pre <= 200, #shouldn't filter out post >200
      sbp_pre >= 25,
      sbp_post >= 25,
    nitro_pre <= 50,
    nitro_diff_mcg <= 20,
    nitro_diff_mcg >=-20
    )
)
```
